<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAN Dashboard ‚Äì Full + 3D (GLB external)</title>
<style>
:root{ --bg:#0b0f14; --panel:#0e131a; --fg:#e5e7eb; --muted:#9aa4b2; --border:#1f2430;
       --blue:#60a5fa; --green:#34d399; --amber:#f59e0b; --red:#ef4444; }
*{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--fg);font:13px/1.45 ui-sans-serif,system-ui}
.nav{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;background:#0a0e13;border-bottom:1px solid var(--border);padding:8px 12px}
.chips{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px;border-bottom:1px solid var(--border);background:#0a0e13}
.chip{display:flex;gap:8px;align-items:center;background:#0f1520;border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:999px}
.chip select{background:transparent;border:none;color:var(--fg);outline:none}
.grid{padding:12px;display:grid;grid-template-columns:1.6fr 1fr;gap:12px;max-width:1600px;margin:0 auto}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:10px}
.ph{display:flex;justify-content:space-between;align-items:center;color:var(--muted);border-bottom:1px solid var(--border);padding:8px 10px}
.pb{padding:10px}
.kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.kpi{background:#0f1520;border:1px solid var(--border);border-radius:10px;padding:12px}
.kpi .lbl{color:var(--muted);font-size:12px}.kpi .val{font-size:26px;font-weight:700}
canvas{display:block;width:100%;height:260px;border-radius:8px}.small{height:180px}
.legend{display:flex;gap:10px;color:var(--muted);font-size:12px;margin-bottom:6px}
.legend .it{display:flex;gap:6px;align-items:center;border:1px solid var(--border);background:#0f1520;border-radius:999px;padding:2px 8px}
.sw{width:10px;height:10px;border-radius:2px}
.gauges{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.gauge{position:relative;height:180px}.gauge canvas{height:180px}.gauge .cap{position:absolute;left:0;right:0;bottom:8px;text-align:center;color:var(--muted);font-size:12px}
.full{grid-column:1 / -1}

/* 3D panel */
.viewer{position:relative}
.viewer canvas{background:#0b1119;border-radius:8px;height:300px;width:100%}
.toolbar{position:absolute;top:10px;right:10px;display:flex;gap:8px;z-index:5}
.btn{background:#0f1520;border:1px solid var(--border);border-radius:8px;color:#e5e7eb;padding:6px 10px;cursor:pointer;font-size:12px}
.hint{position:absolute;bottom:10px;left:10px;color:#9aa4b2;font-size:12px;z-index:3}
.banner{background:#1c222e;border:1px solid #334155;border-radius:8px;padding:6px 10px;color:#9aa4b2;margin:8px 10px 0}
</style>
</head>
<body>
<div class="nav"><div>üè† Dashboards ‚Ä∫ <b>j1939-truck</b></div><div style="color:var(--muted)">CAN Debugger ‚Äì Full</div></div>
<div class="chips">
  <div class="chip">device <select><option>958d2219</option></select></div>
  <div class="chip">message <select><option>can1_at1fc1_s01</option></select></div>
  <div class="chip">signal <select><option>aftertreatment1fuelpressure1</option></select></div>
  <div class="chip">aggregation <select><option>AVG</option><option>MIN</option><option>MAX</option></select></div>
</div>

<div class="grid">
  <div class="panel"><div class="pb kpis">
    <div class="kpi"><div class="lbl">Distance</div><div class="val" id="kpiDistance">465 Mm</div></div>
    <div class="kpi"><div class="lbl">Operation</div><div class="val" id="kpiOperation">51.2 week</div></div>
    <div class="kpi"><div class="lbl">Speed</div><div class="val" id="kpiSpeed">56 km/h</div></div>
    <div class="kpi"><div class="lbl">Fuel Rate</div><div class="val" id="kpiFuelRate">30 l/h</div></div>
    <div class="kpi"><div class="lbl">Fuel Eco‚Ä¶</div><div class="val" id="kpiEco">2.5 km/l</div></div>
  </div></div>

  <div class="panel"><div class="ph"><div>Fuel (%)</div></div><div class="pb"><div class="gauge"><canvas id="fuelGauge"></canvas><div class="cap"><span id="fuelLbl" style="font-weight:600">51%</span> fuel</div></div></div></div>

  <div class="panel"><div class="ph"><div>Speed (km/h)</div></div><div class="pb"><div class="legend" id="lgSpeed"></div><canvas id="speed"></canvas></div></div>
  <div class="panel"><div class="ph"><div>GPS Position</div></div><div class="pb"><canvas id="map" class="map"></canvas></div></div>

  <!-- 3D Vehicle -->
  <div class="panel"><div class="ph"><div>Vehicle 3D</div><div>üñ±Ô∏è sol: orbit ‚Ä¢ saƒü: pan ‚Ä¢ tekerlek: zoom</div></div>
    <div class="pb viewer">
      <div class="banner" id="banner" style="display:none">Otomatik <b>vehicle.glb</b> y√ºkleme, dosyayƒ± <code>file://</code> olarak a√ßtƒ±ƒüƒ±nƒ±zda g√ºvenlik nedeniyle √ßalƒ±≈ümayabilir. K√º√ß√ºk bir sunucu ile a√ßƒ±n: <code>python -m http.server 8000</code></div>
      <canvas id="gl"></canvas>
      <div class="toolbar">
        <label class="btn"><input id="file" type="file" accept=".glb" style="display:none">Dosyadan Y√ºkle (.glb)</label>
        <button class="btn" id="wire">Wireframe</button>
        <button class="btn" id="reset">Reset</button>
      </div>
      <div class="hint">Bu HTML ile aynƒ± klas√∂rde <b>vehicle.glb</b> varsa otomatik y√ºklenir.</div>
    </div>
  </div>

  <div class="panel"><div class="ph"><div>Message: can1_at1fc1_s01 | aftertreatment1fuelpressure1</div></div><div class="pb"><canvas id="pressure" class="small"></canvas></div></div>
  <div class="panel"><div class="ph"><div>Temperatures (degC)</div></div><div class="pb">
    <div class="gauges">
      <div class="gauge"><canvas id="oil"></canvas><div class="cap"><span id="oilLbl" style="font-weight:600">105¬∞C</span> oil</div></div>
      <div class="gauge"><canvas id="fuelT"></canvas><div class="cap"><span id="fuelTLbl" style="font-weight:600">41¬∞C</span> fuel</div></div>
      <div class="gauge"><canvas id="coolant"></canvas><div class="cap"><span id="coolantLbl" style="font-weight:600">97¬∞C</span> coolant</div></div>
    </div>
  </div></div>

  <div class="panel"><div class="ph"><div>EngineSpeed (rpm)</div></div><div class="pb"><canvas id="rpm" class="small"></canvas></div></div>
  <div class="panel"><div class="ph"><div>'Duty Cycle' (RPM by %hours)</div></div><div class="pb"><canvas id="donut" class="small"></canvas></div></div>

  <div class="panel full"><div class="ph"><div>Warning Lamps</div></div><div class="pb"><canvas id="lamps" class="small"></canvas></div></div>
  
  <!-- Live CAN Feed -->
  <div class="panel full"><div class="ph"><div>Live CAN Feed</div></div>
    <div class="pb" style="max-height:260px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px" id="feed"></div>
  </div>
</div>

<script>
/* ----------------- Charts & helpers (same as before) ----------------- */
function ctx2d(canvas){ var dpr=window.devicePixelRatio||1; var r=canvas.getBoundingClientRect(); canvas.width=Math.round(r.width*dpr); canvas.height=Math.round(r.height*dpr); var c=canvas.getContext('2d'); c.setTransform(dpr,0,0,dpr,0,0); c.imageSmoothingEnabled=true; return c; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); } function now(){ return Date.now()/1000; } function rand(){ return (Math.random()+Math.random()+Math.random()+Math.random()-2)/2; }
function LineChart(el,col){ this.c=el; this.ctx=ctx2d(el); this.col=col||'#60a5fa'; this.pad={l:46,r:12,t:12,b:22}; this.data=[]; this.xmin=0; this.xmax=1; }
LineChart.prototype.setRange=function(a,b){ this.xmin=a; this.xmax=b; };
LineChart.prototype.push=function(t,v){ this.data.push({t:+t,v:+v}); if(this.data.length>20000) this.data.splice(0,this.data.length-20000); };
LineChart.prototype._x=function(t){ var w=this.c.getBoundingClientRect().width-this.pad.l-this.pad.r; return this.pad.l+(t-this.xmin)*w/(this.xmax-this.xmin); };
LineChart.prototype._y=function(v,y0,y1){ var h=this.c.getBoundingClientRect().height-this.pad.t-this.pad.b; return this.pad.t+(y1-v)*h/(y1-y0); };
LineChart.prototype.draw=function(){ var ctx=this.ctx, r=this.c.getBoundingClientRect(), W=r.width, H=r.height; ctx.clearRect(0,0,W,H);
  var y0=Infinity,y1=-Infinity,i,p; for(i=0;i<this.data.length;i++){ p=this.data[i]; if(p.t>=this.xmin&&p.t<=this.xmax){ if(p.v<y0)y0=p.v; if(p.v>y1)y1=p.v; } } if(!isFinite(y0)){y0=0;y1=1;} if(y0===y1){y0-=1;y1+=1;}
  ctx.strokeStyle='#1f2430'; ctx.beginPath(); ctx.moveTo(this.pad.l,this.pad.t); ctx.lineTo(this.pad.l,H-this.pad.b); ctx.lineTo(W-this.pad.r,H-this.pad.b); ctx.stroke();
  ctx.strokeStyle='#141a23'; ctx.fillStyle='#9aa4b2'; ctx.font='11px ui-sans-serif'; for(i=0;i<=5;i++){ var v=y0+(y1-y0)*i/5; var py=this._y(v,y0,y1); ctx.beginPath(); ctx.moveTo(this.pad.l,py); ctx.lineTo(W-this.pad.r,py); ctx.stroke(); ctx.fillText(v.toFixed(0),6,py+3); }
  ctx.strokeStyle=this.col; ctx.lineWidth=1.6; ctx.beginPath(); var started=false; for(i=0;i<this.data.length;i++){ p=this.data[i]; if(p.t<this.xmin||p.t>this.xmax) continue; var xx=this._x(p.t), yy=this._y(p.v,y0,y1); if(!started){ctx.moveTo(xx,yy); started=true;} else ctx.lineTo(xx,yy);} ctx.stroke(); };
function drawGauge(el,val,min,max,z,fmt){ z=z||[{to:.2,color:'#ef4444'},{to:.5,color:'#f59e0b'},{to:1,color:'#34d399'}]; var ctx=ctx2d(el); var r=el.getBoundingClientRect(); var W=r.width,H=r.height; var cx=W/2,cy=H*0.95,R=Math.min(W,H*1.7)/2.3; ctx.clearRect(0,0,W,H); ctx.lineWidth=14; ctx.lineCap='round';
 ctx.strokeStyle='#141a23'; ctx.beginPath(); ctx.arc(cx,cy,R,Math.PI,2*Math.PI); ctx.stroke(); var f=0; for(var i=0;i<z.length;i++){ var a0=Math.PI+f*Math.PI,a1=Math.PI+z[i].to*Math.PI; ctx.strokeStyle=z[i].color; ctx.beginPath(); ctx.arc(cx,cy,R,a0,a1); ctx.stroke(); f=z[i].to; }
 var vn=clamp((val-min)/(max-min),0,1); ctx.strokeStyle='#e5e7eb'; ctx.beginPath(); ctx.arc(cx,cy,R,Math.PI+vn*Math.PI,2*Math.PI); ctx.stroke(); ctx.fillStyle='#e5e7eb'; ctx.font='600 20px ui-sans-serif'; ctx.textAlign='center'; ctx.fillText(fmt?fmt(val):val.toFixed(0), cx, cy-R*0.55); }
function drawDonut(el,arr){ var ctx=ctx2d(el); var r=el.getBoundingClientRect(); var W=r.width,H=r.height; var cx=W/2,cy=H/2,R=Math.min(W,H)/2.2,t=R*0.45; ctx.clearRect(0,0,W,H); var tot=1,i; for(i=0;i<arr.length;i++) tot+=arr[i].value; var a=-Math.PI/2; for(i=0;i<arr.length;i++){ var sp=2*Math.PI*(arr[i].value/tot); ctx.beginPath(); ctx.arc(cx,cy,R,a,a+sp); ctx.arc(cx,cy,R-t,a+sp,a,true); ctx.closePath(); ctx.fillStyle=arr[i].color; ctx.fill(); a+=sp; } ctx.fillStyle='#9aa4b2'; ctx.font='12px ui-sans-serif'; ctx.textAlign='center'; ctx.fillText('RPM Duty Cycle', cx, cy+4); }
function drawRoute(el,pts){ var ctx=ctx2d(el); var r=el.getBoundingClientRect(); var W=r.width,H=r.height; var pad=20,lats=pts.map(p=>p.lat),lons=pts.map(p=>p.lon); var minLat=Math.min.apply(null,lats),maxLat=Math.max.apply(null,lats),minLon=Math.min.apply(null,lons),maxLon=Math.max.apply(null,lons);
 function X(lon){ return pad+(lon-minLon)*(W-2*pad)/(maxLon-minLon||1); } function Y(lat){ return H-pad-(lat-minLat)*(H-2*pad)/(maxLat-minLat||1); }
 var i; ctx.strokeStyle='#141a23'; for(i=0;i<=6;i++){ var px=pad+i*(W-2*pad)/6; ctx.beginPath(); ctx.moveTo(px,pad); ctx.lineTo(px,H-pad); ctx.stroke(); } for(i=0;i<=4;i++){ var py=pad+i*(H-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad,py); ctx.lineTo(W-pad,py); ctx.stroke(); }
 ctx.strokeStyle='#f59e0b'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(X(pts[0].lon),Y(pts[0].lat)); for(i=0;i<pts.length;i++){ ctx.lineTo(X(pts[i].lon),Y(pts[i].lat)); } ctx.stroke();
 ctx.fillStyle='#34d399'; var s=pts[0]; ctx.beginPath(); ctx.arc(X(s.lon),Y(s.lat),3,0,2*Math.PI); ctx.fill(); ctx.fillStyle='#ef4444'; var e=pts[pts.length-1]; ctx.beginPath(); ctx.arc(X(e.lon),Y(e.lat),3,0,2*Math.PI); ctx.fill(); }

/* ----------------- Demo data to show charts ----------------- */
var speedC=new LineChart(document.getElementById('speed'),'#60a5fa');
var pressC=new LineChart(document.getElementById('pressure'),'#34d399');
var rpmC  =new LineChart(document.getElementById('rpm'),'#f59e0b');
var lampsC=new LineChart(document.getElementById('lamps'),'#22d3ee');
function seed(){ var t=now(), span=60*40, i, vs=0, fp=420, rr=1000;
  speedC.setRange(t-span,t); pressC.setRange(t-span,t); rpmC.setRange(t-span,t); lampsC.setRange(t-span,t);
  for(i=0;i<span;i+=5){ vs=clamp(vs+rand()*3+Math.max(0,rand()*1.2),0,110); fp=clamp(fp+rand()*50+(vs>20?rand()*30:0),320,950); rr=clamp(rr+rand()*40+vs*0.9,600,2600);
    var tt=t-span+i; speedC.push(tt,vs); pressC.push(tt,fp); rpmC.push(tt,rr); lampsC.push(tt,Math.random()<0.05?1:0); }
}
function redraw(){ speedC.draw(); pressC.draw(); rpmC.draw(); lampsC.draw(); }
seed(); redraw();
let fuel=51,oil=105,fuelT=41,cool=97;
function drawG(){ drawGauge(document.getElementById('fuelGauge'),fuel,0,100,null,function(v){return v.toFixed(0)+'%';}); drawGauge(document.getElementById('oil'),oil,40,140,null,function(v){return v.toFixed(0)+'¬∞C';}); drawGauge(document.getElementById('fuelT'),fuelT,-10,90,null,function(v){return v.toFixed(0)+'¬∞C';}); drawGauge(document.getElementById('coolant'),cool,40,120,null,function(v){return v.toFixed(0)+'¬∞C';}); 
  document.getElementById('fuelLbl').textContent = fuel.toFixed(0)+'%'; document.getElementById('oilLbl').textContent = oil.toFixed(0)+'¬∞C'; document.getElementById('fuelTLbl').textContent = fuelT.toFixed(0)+'¬∞C'; document.getElementById('coolantLbl').textContent = cool.toFixed(0)+'¬∞C'; }
drawG(); setInterval(function(){ fuel=clamp(fuel+rand()*0.2-0.06,8,100); oil=clamp(oil+rand()*0.3,90,125); fuelT=clamp(fuelT+rand()*0.25,25,70); cool=clamp(cool+rand()*0.25,85,115); drawG(); }, 900);
function donut(){ var arr=rpmC.data.slice(Math.max(0,rpmC.data.length-600)); var b=[{label:'<700',min:0,max:700,color:'#64748b',value:0},{label:'700-1200',min:700,max:1200,color:'#60a5fa',value:0},{label:'1200-2000',min:1200,max:2000,color:'#34d399',value:0},{label:'>2000',min:2000,max:9999,color:'#f59e0b',value:0}]; 
  var i; for(i=0;i<arr.length;i++){ var p=arr[i]; var j; for(j=0;j<b.length;j++){ if(p.v>=b[j].min && p.v<b[j].max){ b[j].value++; break; } } } drawDonut(document.getElementById('donut'), b); }
donut(); setInterval(donut,1500);
var route=[], la=51.45, lo=-0.99; for(var i=0;i<60;i++){ lo+=(Math.random()*2-1)*0.04; la+=(Math.random()*2-1)*0.02; route.push({lat:la,lon:lo}); } drawRoute(document.getElementById('map'), route);
(function(){ var el=document.getElementById('lgSpeed'); var it=document.createElement('div'); it.className='it'; it.innerHTML='<span class="sw" style="background:var(--blue)"></span><b>AVG_WheelBasedVehicleSpeed</b>'; el.appendChild(it); })();

(function(){
  try{
    function mul(a,b){ var o=new Float32Array(16),r,c; for(r=0;r<4;r++){ for(c=0;c<4;c++){ o[r*4+c]=a[r*4+0]*b[0*4+c]+a[r*4+1]*b[1*4+c]+a[r*4+2]*b[2*4+c]+a[r*4+3]*b[3*4+c]; } } return o; }
    function T(x,y,z){ var m=new Float32Array(16); m[0]=m[5]=m[10]=m[15]=1; m[12]=x; m[13]=y; m[14]=z; return m; }

    var banner=document.getElementById('banner');
    var canvas=document.getElementById('gl'); var gl=canvas.getContext('webgl',{antialias:true}); if(!gl){ var c=ctx2d(canvas); c.fillStyle='#9aa4b2'; c.fillText('WebGL yok',12,22); return; }
    function size(){ var dpr=window.devicePixelRatio||1; var r=canvas.getBoundingClientRect(); canvas.width=Math.round(r.width*dpr); canvas.height=Math.round(r.height*dpr); gl.viewport(0,0,canvas.width,canvas.height); gl.clearColor(0.07,0.09,0.13,1); }
    window.addEventListener('resize', size);
    var vs='attribute vec3 aP;attribute vec3 aN;uniform mat4 uM,uV,uP;uniform mat3 uNm;varying vec3 vN;varying vec3 vW;void main(){vec4 W=uM*vec4(aP,1.0);vW=W.xyz;vN=normalize(uNm*aN);gl_Position=uP*uV*W;}';
    var fs='precision mediump float;varying vec3 vN;varying vec3 vW;uniform vec3 uCol,uLight,uEye;uniform float uWire;void main(){vec3 N=normalize(vN);vec3 L=normalize(-uLight);vec3 V=normalize(uEye-vW);float d=max(dot(N,L),0.0);vec3 H=normalize(L+V);float s=pow(max(dot(N,H),0.0),32.0);vec3 base=uCol*(0.12+0.88*d)+vec3(0.10)*s;gl_FragColor=vec4(mix(base,vec3(0.92),uWire),1.0);}';
    function sh(src,t){ var s=gl.createShader(t); gl.shaderSource(s,src); gl.compileShader(s); return s; }
    var pr=gl.createProgram(); gl.attachShader(pr,sh(vs,gl.VERTEX_SHADER)); gl.attachShader(pr,sh(fs,gl.FRAGMENT_SHADER)); gl.linkProgram(pr); gl.useProgram(pr);
    var loc={ aP:gl.getAttribLocation(pr,'aP'), aN:gl.getAttribLocation(pr,'aN'), uM:gl.getUniformLocation(pr,'uM'), uV:gl.getUniformLocation(pr,'uV'), uP:gl.getUniformLocation(pr,'uP'), uNm:gl.getUniformLocation(pr,'uNm'), uCol:gl.getUniformLocation(pr,'uCol'), uLight:gl.getUniformLocation(pr,'uLight'), uEye:gl.getUniformLocation(pr,'uEye'), uWire:gl.getUniformLocation(pr,'uWire') };
    gl.enable(gl.DEPTH_TEST);
    var ext_uint = gl.getExtension('OES_element_index_uint');
    function makeVBO(d){ var b=gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER,b); gl.bufferData(gl.ARRAY_BUFFER,d,gl.STATIC_DRAW); return b; }
    function makeIBO(d,is32){ var b=gl.createBuffer(); gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,b); gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,d,gl.STATIC_DRAW); return {buf:b,type:is32?gl.UNSIGNED_INT:gl.UNSIGNED_SHORT,count:d.length}; }
    var gvb=makeVBO(new Float32Array([-8,0,-8, 8,0,-8, 8,0,8, -8,0,8])); var gnb=makeVBO(new Float32Array([0,1,0,0,1,0,0,1,0,0,1,0])); var gib=makeIBO(new Uint16Array([0,1,2, 0,2,3]), false);

    var R=10, TH=.9, PH=.3, TX=0, TY=0, wire=0; var dragging=false,panning=false,lx=0,ly=0;
    canvas.addEventListener('mousedown',function(e){ if(e.button===2)panning=true; else dragging=true; lx=e.clientX; ly=e.clientY; });
    window.addEventListener('mouseup',function(){ dragging=false;panning=false; });
    window.addEventListener('mousemove',function(e){ if(!(dragging||panning))return; var dx=(e.clientX-lx)/160, dy=(e.clientY-ly)/160; lx=e.clientX; ly=e.clientY; if(dragging){ TH-=dx; PH=Math.max(-1.2,Math.min(1.2,PH-dy)); } else { TX+=dx*R*0.5; TY-=dy*R*0.5; } });
    canvas.addEventListener('contextmenu',function(e){ e.preventDefault(); });
    canvas.addEventListener('wheel',function(e){ e.preventDefault(); R*=(1+Math.sign(e.deltaY)*0.08); R=Math.max(2,Math.min(80,R)); }, {passive:false});
    document.getElementById('wire').onclick=function(){ wire=wire?0:1; };
    document.getElementById('reset').onclick=function(){ R=10;TH=.9;PH=.3;TX=0;TY=0; };

    function typeCount(t){ return t==='SCALAR'?1: t==='VEC2'?2: t==='VEC3'?3: t==='VEC4'?4: t==='MAT4'?16: 0; }
    function parseGLB(buf){
      var dv=new DataView(buf); if(dv.getUint32(0,true)!==0x46546C67) throw 'Not GLB'; if(dv.getUint32(4,true)!==2) throw 'GLB v2';
      var o=12, json=null, bin=null;
      while(o<dv.byteLength){ var len=dv.getUint32(o,true), type=dv.getUint32(o+4,true), start=o+8; if(type===0x4E4F534A){ json=JSON.parse(new TextDecoder('utf-8').decode(new Uint8Array(buf,start,len))); } else if(type===0x004E4942){ bin=new Uint8Array(buf,start,len); } o=start+len; }
      var prims=(json.meshes||[]).map(function(){return []});
      function getAcc(i){ var acc=json.accessors[i]; var bv=json.bufferViews[acc.bufferView]; var comp=acc.componentType; var cnt=acc.count; var bytes=bin.subarray((bv.byteOffset||0)+(acc.byteOffset||0), (bv.byteOffset||0)+(acc.byteOffset||0)+ (bv.byteLength||0));
        var arr=null; if(comp===5126) arr=new Float32Array(bytes.buffer, bytes.byteOffset, cnt*typeCount(acc.type));
        else if(comp===5125) arr=new Uint32Array(bytes.buffer, bytes.byteOffset, cnt*typeCount(acc.type));
        else if(comp===5123) arr=new Uint16Array(bytes.buffer, bytes.byteOffset, cnt*typeCount(acc.type));
        else if(comp===5121) arr=new Uint8Array(bytes.buffer, bytes.byteOffset, cnt*typeCount(acc.type));
        else throw 'Unsupported comp'; return {acc:acc, data:arr}; }
      var nodes=json.nodes||[], meshes=json.meshes||[]; var scenes=[]; var scene=json.scenes[json.scene||0];
      function I4(){ var m=new Float32Array(16); m[0]=m[5]=m[10]=m[15]=1; return m; }
      function nodeM(n){ if(!n) return I4(); var m=I4(); if(n.translation){ m=mul(m,T(n.translation[0],n.translation[1],n.translation[2])); }
        if(n.rotation){ var q=n.rotation, x=q[0],y=q[1],z=q[2],w=q[3]; var mm=new Float32Array([1-2*y*y-2*z*z,2*x*y+2*w*z,2*x*z-2*w*y,0,2*x*y-2*w*z,1-2*x*x-2*z*z,2*y*z+2*w*x,0,2*x*z+2*w*y,2*y*z-2*w*x,1-2*x*x-2*y*y,0,0,0,0,1]); m=mul(m,mm); }
        if(n.scale){ m=mul(m,new Float32Array([n.scale[0],0,0,0, 0,n.scale[1],0,0, 0,0,n.scale[2],0, 0,0,0,1])); } return m; }
      function collect(i,parent){ var n=nodes[i]; var M=mul(parent||I4(), nodeM(n)); if(n.mesh!=null) scenes.push({mesh:n.mesh, matrix:M}); (n.children||[]).forEach(function(ch){ collect(ch,M); }); }
      (scene.nodes||[]).forEach(function(n){ collect(n,null); });
      for(var m=0;m<meshes.length;m++){ var mesh=meshes[m]; for(var pi=0;pi<mesh.primitives.length;pi++){ var p=mesh.primitives[pi]; var pos=getAcc(p.attributes.POSITION); var nor=p.attributes.NORMAL!=null?getAcc(p.attributes.NORMAL):null; var idx=p.indices!=null?getAcc(p.indices):null; var vbo=makeVBO(new Float32Array(pos.data)); var nbo=makeVBO(nor? new Float32Array(nor.data): new Float32Array(pos.data.length)); var ibo=null;
          if(idx){ var is32=(idx.data instanceof Uint32Array); if(is32 && !ext_uint) console.warn('Uint32 indices need extension'); ibo=makeIBO(idx.data,is32); } else { var count=pos.acc.count; var id=new Uint16Array(count); for(var j=0;j<count;j++) id[j]=j; ibo=makeIBO(id,false); }
          prims[m].push({vbo:vbo,nbo:nbo,ibo:ibo}); } }
      var min=[1e9,1e9,1e9], max=[-1e9,-1e9,-1e9]; for(var ai=0;ai<json.accessors.length;ai++){ var a=json.accessors[ai]; if(a.type==='VEC3'&&a.min&&a.max){ min=[Math.min(min[0],a.min[0]),Math.min(min[1],a.min[1]),Math.min(min[2],a.min[2])]; max=[Math.max(max[0],a.max[0]),Math.max(max[1],a.max[1]),Math.max(max[2],a.max[2])]; } }
      return {scenes:scenes, prims:prims, min:min, max:max};
    }
    var model=null;
    function fitModel(){ if(!model) return; var dx=model.max[0]-model.min[0], dy=model.max[1]-model.min[1], dz=model.max[2]-model.min[2]; var diag=Math.hypot(dx,dy,dz)||1; R=diag*1.3; TX=-(model.min[0]+model.max[0])/2; TY=-(model.min[1]+model.max[1])/2; }
    function bind(p){ gl.bindBuffer(gl.ARRAY_BUFFER,p.vbo); gl.enableVertexAttribArray(loc.aP); gl.vertexAttribPointer(loc.aP,3,gl.FLOAT,false,0,0); gl.bindBuffer(gl.ARRAY_BUFFER,p.nbo); gl.enableVertexAttribArray(loc.aN); gl.vertexAttribPointer(loc.aN,3,gl.FLOAT,false,0,0); gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,p.ibo.buf); }
    function draw(){ size(); gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT); var eye=[R*Math.cos(PH)*Math.cos(TH),R*Math.sin(PH),R*Math.cos(PH)*Math.sin(TH)]; var V=(function(){let e=eye,c=[TX,TY,0],u=[0,1,0]; let z=[e[0]-c[0],e[1]-c[1],e[2]-c[2]],zl=Math.hypot(z[0],z[1],z[2]); z=[z[0]/zl,z[1]/zl,z[2]/zl]; let x=[u[1]*z[2]-u[2]*z[1],u[2]*z[0]-u[0]*z[2],u[0]*z[1]-u[1]*z[0]],xl=Math.hypot(x[0],x[1],x[2]); x=[x[0]/xl,x[1]/xl,x[2]/xl]; let y=[z[1]*x[2]-z[2]*x[1],z[2]*x[0]-z[0]*x[2],z[0]*x[1]-z[1]*x[0]]; var m=new Float32Array(16); m[0]=x[0];m[1]=y[0];m[2]=z[0];m[3]=0; m[4]=x[1];m[5]=y[1];m[6]=z[1];m[7]=0; m[8]=x[2];m[9]=y[2];m[10]=z[2];m[11]=0; m[12]=-(x[0]*e[0]+x[1]*e[1]+x[2]*e[2]); m[13]=-(y[0]*e[0]+y[1]*e[1]+y[2]*e[2]); m[14]=-(z[0]*e[0]+z[1]*e[1]+z[2]*e[2]); m[15]=1; return m;})();
      var P=(function(){var f=Math.PI/4,a=canvas.width/canvas.height,nr=0.1,fr=500,t=1/Math.tan(f/2), m=new Float32Array(16); m[0]=t/a; m[5]=t; m[10]=(fr+nr)/(nr-fr); m[11]=-1; m[14]=(2*fr*nr)/(nr-fr); return m;})();
      gl.uniformMatrix4fv(loc.uV,false,V); gl.uniformMatrix4fv(loc.uP,false,P); gl.uniform3fv(loc.uEye,new Float32Array(eye)); gl.uniform3fv(loc.uLight,new Float32Array([0.7,1.0,0.6])); gl.uniform1f(loc.uWire, wire);
      gl.bindBuffer(gl.ARRAY_BUFFER, gvb); gl.enableVertexAttribArray(loc.aP); gl.vertexAttribPointer(loc.aP,3,gl.FLOAT,false,0,0); gl.bindBuffer(gl.ARRAY_BUFFER, gnb); gl.enableVertexAttribArray(loc.aN); gl.vertexAttribPointer(loc.aN,3,gl.FLOAT,false,0,0); gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, gib);
      var MG=(function(){ var m=new Float32Array(16); m[0]=m[5]=m[10]=m[15]=1; m[13]=-1.1; return m; })(); gl.uniformMatrix4fv(loc.uM,false,MG); gl.uniformMatrix3fv(loc.uNm,false,(function(m){var a00=m[0],a01=m[1],a02=m[2],a10=m[4],a11=m[5],a12=m[6],a20=m[8],a21=m[9],a22=m[10]; var b01=a22*a11-a12*a21, b11=-a22*a10+a12*a20, b21=a21*a10-a11*a20; var det=a00*b01+a01*b11+a02*b21; if(!det) det=1; var id=1/det; return new Float32Array([ b01*id,(-a22*a01+a02*a21)*id,(a12*a01-a02*a11)*id, b11*id,(a22*a00-a02*a20)*id,(-a12*a00+a02*a10)*id, b21*id,(-a21*a00+a01*a20)*id,(a11*a00-a01*a10)*id ]);})(MG));
      gl.uniform3fv(loc.uCol,new Float32Array([0.12,0.15,0.20])); gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0);
      if(model){ for(var si=0;si<model.scenes.length;si++){ var inst=model.scenes[si]; var M=inst.matrix; gl.uniformMatrix4fv(loc.uM,false,M); gl.uniformMatrix3fv(loc.uNm,false,(function(m){var a00=m[0],a01=m[1],a02=m[2],a10=m[4],a11=m[5],a12=m[6],a20=m[8],a21=m[9],a22=m[10]; var b01=a22*a11-a12*a21, b11=-a22*a10+a12*a20, b21=a21*a10-a11*a20; var det=a00*b01+a01*b11+a02*b21; if(!det) det=1; var id=1/det; return new Float32Array([ b01*id,(-a22*a01+a02*a21)*id,(a12*a01-a02*a11)*id, b11*id,(a22*a00-a02*a20)*id,(-a12*a00+a02*a10)*id, b21*id,(-a21*a00+a01*a20)*id,(a11*a00-a01*a10)*id ]);})(M));
        gl.uniform3fv(loc.uCol,new Float32Array([0.92,0.92,0.95])); var parts=model.prims[inst.mesh]; for(var pi=0;pi<parts.length;pi++){ var p=parts[pi]; gl.bindBuffer(gl.ARRAY_BUFFER,p.vbo); gl.enableVertexAttribArray(loc.aP); gl.vertexAttribPointer(loc.aP,3,gl.FLOAT,false,0,0); gl.bindBuffer(gl.ARRAY_BUFFER,p.nbo); gl.enableVertexAttribArray(loc.aN); gl.vertexAttribPointer(loc.aN,3,gl.FLOAT,false,0,0); gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,p.ibo.buf); gl.drawElements(gl.TRIANGLES,p.ibo.count,p.ibo.type,0); if(wire) gl.drawElements(gl.LINES,p.ibo.count,p.ibo.type,0); } } }
      requestAnimationFrame(draw);
    window.__setModelFromBuffer = function(buf){ try{ model=parseGLB(buf); fitModel(); }catch(e){ console.warn('parse fail', e); } };
    }
    requestAnimationFrame(draw);

    if(location.protocol==='file:'){ banner.style.display='block'; }
    fetch('vehicle.glb').then(function(r){ if(!r.ok) throw 0; return r.arrayBuffer(); }).then(function(buf){ model=parseGLB(buf); fitModel(); }).catch(function(){ console.log('vehicle.glb auto-load ba≈üarƒ±sƒ±z (muhtemelen file://). Dosyadan se√ßebilirsiniz.'); });

    document.getElementById('file').addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(!f) return; f.arrayBuffer().then(function(buf){ try{ model=parseGLB(buf); fitModel(); }catch(err){ alert('GLB okunamadƒ±: '+err); } }); });
  }catch(err){ console.error('3D error', err); }
})();

// ----------------- Live CAN binding -----------------
(function(){
  const kpiSpeedEl = document.getElementById('kpiSpeed');
  const fuelLblEl  = document.getElementById('fuelLbl');
  const feedEl     = document.getElementById('feed');
  // Hƒ±z grafiƒüine canlƒ± akƒ±≈ü ekleyelim
  function pushSpeed(tsSec, val){
    speedC.push(tsSec, val);
    const span = 60*10; // son 10 dk
    const t = now();
    speedC.setRange(t-span, t);
    speedC.draw();
    kpiSpeedEl.textContent = Math.round(val) + ' km/h';
  }

  // Yakƒ±t g√∂sterge g√ºncellemesi (eƒüer sinyal varsa)
  function pushFuel(percent){
    if (!isFinite(percent)) return;
    try { fuel = clamp(percent, 0, 100); drawG(); } catch {}
  }

  window.addEventListener('message', function(ev){
    const msg = ev.data;
    if (!msg || msg.type !== 'can' || !msg.payload) return;
    const obj = msg.payload; // { ts,bus,id,dlc,raw,name,signals:{...} }

    // Feed‚Äôe satƒ±r ekle
    try {
      const line = `[${new Date().toLocaleTimeString()}] ${msg.topic||''} ${obj.name||''} id=${obj.id?.toString(16)} dlc=${obj.dlc} raw=${obj.raw}`;
      const div = document.createElement('div');
      div.textContent = line;
      feedEl.prepend(div);
      while (feedEl.childElementCount > 200) feedEl.removeChild(feedEl.lastChild);
    } catch {}

    // √ñrnek e≈üleme: hƒ±z sinyal isimlerinde "speed" ge√ßen deƒüerleri bul
    let speedVal = null;
    if (obj.signals) {
      for (const k in obj.signals) {
        if (/speed/i.test(k)) { speedVal = Number(obj.signals[k]); break; }
      }
      // Yakƒ±t y√ºzdesi i√ßin fuel ve benzeri anahtarlar
      let fuelVal = null;
      for (const k in obj.signals) {
        if (/(fuel.*level|fuel.*percent|fuel.*pct)/i.test(k)) { fuelVal = Number(obj.signals[k]); break; }
      }
      if (isFinite(fuelVal)) pushFuel(fuelVal);
    }

    // Zaman damgasƒ± mikrosaniye ‚Üí saniye
    const t = obj.ts ? (obj.ts/1e6) : now();
    if (isFinite(speedVal)) pushSpeed(t, speedVal);
  });
})();
</script>
</body></html>
