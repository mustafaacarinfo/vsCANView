<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CAN Debugger ‚Äì Modular</title>
  <!-- debug.js kaldƒ±rƒ±ldƒ± (eri≈üim hatasƒ± veriyordu) -->
  <link rel="stylesheet" href="__FONTS_CSS__" />
  <link rel="stylesheet" href="__CSS_URI__" />
  <link rel="stylesheet" href="__SIGNALS_CSS_URI__" />
  <!-- Chart.js i√ßin mod√ºl tanƒ±mlamasƒ± -->
  <script type="importmap">
    {
      "imports": {
        "chart.js": "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/+esm",
        "chartjs-adapter-date-fns": "https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/+esm"
      }
    }
  </script>
  <!-- Three.js ve GLTFLoader i√ßin direkt script y√ºkleme - VS Code WebView uyumluluƒüu i√ßin -->
  <script>
    // Three.js ve GLTFLoader global y√ºkleyici
    window.loadThreeResources = function() {
      console.log('Three.js kaynaklarƒ± y√ºkleniyor...');
      return Promise.all([
        new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = './js/three/vendor/three.module.js';
          script.onload = () => {
            console.log('Three.js y√ºklendi');
            resolve();
          };
          script.onerror = (err) => {
            console.error('Three.js y√ºkleme hatasƒ±:', err);
            reject(new Error('Three.js y√ºklenemedi'));
          };
          document.head.appendChild(script);
        }),
        new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = './js/three/vendor/GLTFLoader.js';
          script.onload = () => {
            console.log('GLTFLoader y√ºklendi');
            resolve();
          };
          script.onerror = (err) => {
            console.error('GLTFLoader y√ºkleme hatasƒ±:', err);
            reject(new Error('GLTFLoader y√ºklenemedi'));
          };
          document.head.appendChild(script);
        })
      ])
      .then(() => {
        console.log('Three.js kaynaklarƒ± hazƒ±r');
        if (window.threeResourcesLoaded) {
          window.threeResourcesLoaded();
        }
      })
      .catch(err => {
        console.error('Three.js kaynaklarƒ± y√ºkleme hatasƒ±:', err);
      });
    };
    
    // Sayfa y√ºklendiƒüinde kaynaklarƒ± y√ºkle
    window.addEventListener('load', () => {
      setTimeout(() => {
        window.loadThreeResources();
      }, 1000);
    });
  </script>
</head>
<body>
  <div class="nav"><div>üè† Dashboards ‚Ä∫ <b>j1939-truck</b></div><div style="color:#9fb0c4">CAN Debugger ‚Äì Modular</div></div>

  <div class="tabs">
  <div class="tab active" data-tab="dash">Overview</div>
  <div class="tab" data-tab="feed">Live Monitor</div>
  <div class="tab" data-tab="signals">Signal Analysis</div>
  <div class="tab" data-tab="dtc">Diagnostics</div>
  <div class="tab" data-tab="sim">Simulator</div>
  <div class="tab" data-tab="log">Log Replay</div>
  <div class="tab" data-tab="script">Automation</div>
  </div>

  <div class="chips">
    <div class="chip"><label>bus</label>
      <select id="busSel"><option>can0</option><option>can1</option><option>vcan0</option></select>
    </div>
    <div class="chip"><label>id/pgn</label>
      <input id="idFilter" placeholder="0x18FEF100 / 8000148" />
    </div>
    <div class="chip"><label>decode</label>
      <select id="decodeSel"><option>RAW</option><option>DBC</option></select>
    </div>
    <div class="chip"><label>signal</label>
      <select id="signalSel" disabled title="Active when DBC is selected"><option>‚Äî</option></select>
    </div>
    <div class="chip"><label>view</label>
      <select id="viewSel"><option>All</option><option>Only speed/rpm</option><option>Only temperatures</option></select>
    </div>
    <div class="chip"><label>rate</label>
      <select id="rateSel"><option>1s</option><option>200ms</option><option>50ms</option></select>
    </div>
    <div class="chip"><button id="pauseBtn" class="btn">‚è∏ Pause</button></div>
  </div>

  <div class="status">
    <div class="badges-container">
      <div class="badge connection-badge">
        <div class="conn-icons">
          <div id="mqttStatus" class="conn-icon"><span id="mqttDot" class="dot fail"></span><span>MQTT</span></div>
          <div id="canStatus" class="conn-icon"><span id="canDot" class="dot fail"></span><span>CAN</span></div>
        </div>
        <span id="connTxt">Disconnected</span>
      </div>
      <div class="badge">msgs/sec: <b id="mps">0</b></div>
      <div class="badge">total: <b id="total">0</b></div>
      <div class="badge">last: <span id="lastTopic">‚Äî</span></div>
    </div>
    <div class="chart-controls">
      <button id="clearCharts" class="btn clear-btn" title="Clear all chart data">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        Clear
      </button>
    </div>
  </div>

  <div id="page-dash" class="page active">
    <div class="grid">
  <div class="panel kpis"><div class="pb kpi-wrap">
  <div class="kpi kpi-distance" data-kpi="distance"><div class="lbl">Distance</div><div class="val" id="kpiDistance">0 km</div></div>
  <div class="kpi kpi-operation" data-kpi="operation"><div class="lbl">Engine Hours</div><div class="val" id="kpiOperation">0 h</div></div>
  <div class="kpi kpi-speed" data-kpi="speed"><div class="lbl">Speed</div><div class="val" id="kpiSpeed">0 km/h</div></div>
  <div class="kpi kpi-fuelrate" data-kpi="fuelrate"><div class="lbl">Fuel Rate</div><div class="val" id="kpiFuelRate">0 l/h</div></div>
  <div class="kpi kpi-eco" data-kpi="eco"><div class="lbl">Fuel Eco</div><div class="val" id="kpiEco">0 km/l</div></div>
      </div></div>

      <div class="panel device">
        <div class="ph"><div>Device</div></div>
        <div class="pb">
          <div id="vehicleHost" class="device-host">
            <canvas id="vehicleCanvas" class="device-canvas"></canvas>
            <div class="notice" id="vehicleNotice"></div>
          </div>
        </div>
      </div>

      <div class="panel speed"><div class="ph"><div>Speed (km/h)</div></div>
        <div class="pb"><div class="legend" id="lgSpeed"></div><canvas id="speed"></canvas></div>
      </div>

      <div class="panel gauge"><div class="ph"><div>Fuel / Fuel Rate</div></div>
        <div class="pb">
          <div class="fuel-flex">
            <div class="fuel-gauge"><canvas id="fuel"></canvas></div>
            <div class="fuel-rate"><canvas id="fuelRate"></canvas></div>
          </div>
        </div>
      </div>

      <div class="panel rpm"><div class="ph"><div>Engine RPM</div></div>
        <div class="pb"><canvas id="rpm"></canvas></div>
      </div>
      
      <div class="panel engine engine-params">
        <div class="ph"><div>Engine Parameters</div></div>
        <div class="pb">
          <div class="eng-grid">
            <div class="eng-card">
              <div class="eng-hd">Oil Pressure</div>
              <canvas id="oilPressure"></canvas>
              <div class="eng-val" id="oilPressureVal">0 kPa</div>
            </div>
            <div class="eng-card">
              <div class="eng-hd">Battery Voltage</div>
              <canvas id="batteryVoltage"></canvas>
              <div class="eng-val" id="batteryVoltageVal">0 V</div>
            </div>
            <div class="eng-card">
              <div class="eng-hd">Manifold Pressure</div>
              <canvas id="intakeManifold"></canvas>
              <div class="eng-val" id="intakeManifoldVal">0 kPa</div>
            </div>
            <div class="eng-card">
              <div class="eng-hd">Coolant Temp</div>
              <canvas id="coolantTemp"></canvas>
              <div class="eng-val" id="coolantTempVal">0 ¬∞C</div>
            </div>
            <div class="eng-card">
              <div class="eng-hd">Oil Temp</div>
              <canvas id="oilTemp"></canvas>
              <div class="eng-val" id="oilTempVal">0 ¬∞C</div>
            </div>
            <div class="eng-card">
              <div class="eng-hd">Exhaust Temp</div>
              <canvas id="exhaustTemp"></canvas>
              <div class="eng-val" id="exhaustTempVal">0 ¬∞C</div>
            </div>
          </div>
        </div>
      </div>

      

      <div class="panel gps"><div class="ph"><div>GPS Position</div></div>
        <div class="pb nav-wrapper">
          <canvas id="navMap"></canvas>
        </div>
      </div>

      <div class="panel pressure"><div class="ph"><div>Aftertreatment Fuel Pressure (kPa)</div></div>
        <div class="pb"><canvas id="pressure" class="small"></canvas></div>
      </div>


      
    </div>
  </div>

  <div id="page-feed" class="page">
    <div class="feed">
      <div class="toolbar">
        <button id="clearFeed" class="btn">Clear</button>
        <button id="exportFeed" class="btn">Export JSON</button>
      </div>
      <div id="feed"></div>
    </div>
  </div>

  <div id="page-signals" class="page">
    <div class="signals-container">
      <div class="signals-header">
        <div class="signals-controls">
          <!-- Signal clear button removed; event handlers use optional chaining to avoid errors -->
        </div>
      </div>
      
      <div class="signal-panel">
        <div class="signal-panel-header">
          <h3>Signal Monitor</h3>
          <div class="signal-search">
            <input type="text" id="signalSearchInput" placeholder="Search signals..." class="signal-search-input">
          </div>
        </div>
        
        <div class="signal-selection-layout">
          <div class="signal-list-container">
            <h4>
              Available Signals <span id="signalCount" class="signal-count">(0)</span>
              <button id="toggleAutoScroll" class="auto-scroll-btn" title="Toggle auto-scroll">
                <span class="auto-scroll-icon">üîÑ</span>
              </button>
            </h4>
            <div class="signal-list-wrapper">
              <div id="multiSignalCheckboxes" class="signal-list">
                <!-- Signal checkboxes will be added here dynamically -->
              </div>
            </div>
          </div>
          
          <div class="signal-chart-container">
            <canvas id="multiSignalAreaChart" height="350"></canvas>
            <div class="signals-legend" id="signalLegend">
              <!-- Signal color legend moved here -->
            </div>
          </div>
        </div>
      </div>
      
      <div class="signal-info-panel">
  <h3>Usage Info</h3>
  <p>This panel lets you track multiple decoded CAN signals in real time.</p>
        <ul>
          <li>Up to 5 signals may be selected</li>
          <li>Selected signals render with distinct colors</li>
          <li>Automatic scaling</li>
          <li>Shows last 60 seconds</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="page-sim" class="page">
    <div style="padding:24px;color:#94a3b8;max-width:760px;line-height:1.5">
      <h2 style="margin-top:0;color:#e5e7eb;font-size:18px">Simulator</h2>
      <p>This section will provide a local generator for <b>J1939 / CAN</b> messages to test dashboards without a real vehicle.</p>
      <ul style="padding-left:18px">
        <li>Planned: Parametric speed / RPM / temperature / pressure scenarios</li>
        <li>Random or scripted data flows</li>
        <li>Custom frame scripting</li>
      </ul>
      <div style="margin-top:16px;padding:12px 14px;border:1px solid #1f2430;border-radius:8px;background:#0f1520;color:#b7c0cd">
        Not implemented yet. Share your priority use‚Äëcases.
      </div>
    </div>
  </div>
  <div id="page-log" class="page">
    <div style="padding:24px;color:#94a3b8;max-width:760px;line-height:1.5">
      <h2 style="margin-top:0;color:#e5e7eb;font-size:18px">Log Replay</h2>
      <p>Replay recorded CAN logs preserving their original timing for historical analysis.</p>
      <ul style="padding-left:18px">
        <li>Planned: .log / .txt / PCAP import</li>
        <li>Variable playback speed (0.25x .. 20x)</li>
        <li>Filter by PGN / ID during replay</li>
      </ul>
      <div style="margin-top:16px;padding:12px 14px;border:1px solid #1f2430;border-radius:8px;background:#0f1520;color:#b7c0cd">
        Not implemented yet. Sample logs will be used for validation.
      </div>
    </div>
  </div>
  <div id="page-script" class="page">
    <div style="padding:24px;color:#94a3b8;max-width:760px;line-height:1.5">
      <h2 style="margin-top:0;color:#e5e7eb;font-size:18px">Automation</h2>
      <p>Scripting area for generating, transforming or reacting to incoming CAN frames.</p>
      <ul style="padding-left:18px">
        <li>Planned: Embedded JS/TS editor</li>
        <li>Sample script library</li>
        <li>Secure sandbox + MQTT publish API</li>
      </ul>
      <div style="margin-top:16px;padding:12px 14px;border:1px solid #1f2430;border-radius:8px;background:#0f1520;color:#b7c0cd">
        Not implemented yet. Provide desired automation examples.
      </div>
    </div>
  </div>
  <div id="page-dtc" class="page">
    <div style="padding:24px;color:#94a3b8;max-width:1100px;line-height:1.5">
      <h2 style="margin-top:0;color:#e5e7eb;font-size:18px">Diagnostics</h2>
      <p>Planned live view for J1939 Diagnostic Trouble Codes (DTC), warning lamps & health status.</p>

      <div class="diag-panel" style="margin-top:4px">
        <h3 style="margin:0 0 8px">DTC Warning Lamps</h3>
        <div class="lamp-grid" id="warningLamps">
          <div class="lamp" data-lamp="mil" data-state="off"><div class="icon">‚ö†</div><div class="label">MIL</div><span class="state">OFF</span></div>
          <div class="lamp" data-lamp="awl" data-state="off"><div class="icon">üü°</div><div class="label">Amber</div><span class="state">OFF</span></div>
          <div class="lamp" data-lamp="rsl" data-state="off"><div class="icon">üõë</div><div class="label">Red Stop</div><span class="state">OFF</span></div>
          <div class="lamp" data-lamp="protect" data-state="off"><div class="icon">üõ°</div><div class="label">Protect</div><span class="state">OFF</span></div>
          <div class="lamp" data-lamp="dpf" data-state="off"><div class="icon">üß™</div><div class="label">DPF</div><span class="state">OFF</span></div>
          <div class="lamp" data-lamp="abs" data-state="off"><div class="icon">üöó</div><div class="label">ABS</div><span class="state">OFF</span></div>
        </div>
        <div style="font-size:11px;color:#6b7280;margin-top:4px">States: OFF / ON / FLASH (from DM1 / DM2 lamp status bits)</div>
      </div>

      <div class="diag-layout" style="margin-top:16px">
        <div class="diag-panel">
          <h3 style="margin:0 0 8px">DTC Monitor</h3>
          <table class="dtc-table" style="width:100%;border-collapse:collapse;font-size:12px">
            <thead style="background:#262626">
              <tr><th>Source</th><th>SPN</th><th>FMI</th><th>Count</th><th>Status</th><th>Last Seen</th></tr>
            </thead>
            <tbody id="dtcBody">
              <tr class="placeholder"><td colspan="6" style="text-align:center;color:#555">No DTCs yet</td></tr>
            </tbody>
          </table>
        </div>
        <div class="diag-panel">
          <h3 style="margin:0 0 8px">Health Summary</h3>
          <ul id="healthSummary" style="list-style:none;margin:0;padding:0;font-size:13px">
            <li data-key="coolant" style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed #333">Coolant Temp <span class="value">‚Äî</span></li>
            <li data-key="oilPress" style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed #333">Oil Pressure <span class="value">‚Äî</span></li>
            <li data-key="battery" style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px dashed #333">Battery Voltage <span class="value">‚Äî</span></li>
            <li data-key="map" style="display:flex;justify-content:space-between;padding:4px 0">Intake Manifold <span class="value">‚Äî</span></li>
          </ul>
        </div>
        <div class="diag-panel">
          <h3 style="margin:0 0 8px">Planned</h3>
          <ul style="padding-left:18px;font-size:13px;margin:0">
            <li>Active vs previously active DTC segregation</li>
            <li>DTC snapshot export</li>
            <li>SPN metadata lookup & descriptions</li>
            <li>Freeze frame capture</li>
          </ul>
        </div>
        <div class="diag-panel">
          <h3 style="margin:0 0 8px">Future Sections Template</h3>
          <ul style="padding-left:18px;font-size:13px;margin:0">
            <li>Aftertreatment / Emissions status</li>
            <li>Battery / Electrical health (voltage min/max, ripple)</li>
            <li>Network health (bus load %, error frames)</li>
            <li>Environmental sensors (ambient temp, baro)</li>
          </ul>
        </div>
      </div>
      <div style="margin-top:16px;padding:12px 14px;border:1px solid #1f2430;border-radius:8px;background:#0f1520;color:#b7c0cd">
        Not implemented yet. (Future) DM1 parser will toggle lamps by setting data-state="on|flash|off".
      </div>
      <div style="margin-top:12px;padding:12px 14px;border:1px dashed #223146;border-radius:8px;background:#0c141d;color:#7d8b99;font-size:12px">
        Template placeholders added for upcoming diagnostic subsystems. Implementation will populate:
        <ul style="margin:6px 0 0 18px;padding:0">
          <li>DM1 stream: real-time active DTCs + lamp bit decoding</li>
          <li>DM2 snapshot: previously active DTC list</li>
          <li>Aggregation: per-source address fault counts & last seen time</li>
          <li>Health KPIs: derived green/amber/red status badges</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Three.js ve GLTFLoader'ƒ± direkt olarak dahil et -->
  <script src="./js/three/vendor/three.module.js"></script>
  <script src="./js/three/vendor/GLTFLoader.js"></script>
  
  <script type="module" src="__APP_JS__"></script>
</body>
</html>